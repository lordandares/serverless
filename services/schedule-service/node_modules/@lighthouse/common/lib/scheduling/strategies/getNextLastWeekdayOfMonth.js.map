{"version":3,"sources":["../../../src/scheduling/strategies/getNextLastWeekdayOfMonth.ts"],"names":["moment","Unit","getNextLastWeekdayOfMonth","end","isInitial","options","start","timezone","duration","frequency","weekday","durationUnit","unit","durationValue","value","frequencyUnit","frequencyValue","dateCursor","mStartOfMonth","tz","add","Month","startOf","year","month","startDay","isoWeekday","date","nextOccurrenceEnd","Day","subtract","Week","valueOf","nextOccurrenceStart","nextDateCursor"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,iBAAnB;AAEA,SAA4BC,IAA5B,QAAwC,qBAAxC;AAEA;;;;AAGA,OAAO,SAASC,yBAAT,OAMsB;AAAA,MAL3BC,GAK2B,QAL3BA,GAK2B;AAAA,MAJ3BC,SAI2B,QAJ3BA,SAI2B;AAAA,MAH3BC,OAG2B,QAH3BA,OAG2B;AAAA,MAF3BC,KAE2B,QAF3BA,KAE2B;AAAA,MAD3BC,QAC2B,QAD3BA,QAC2B;AAAA,MACnBC,QADmB,GACcH,OADd,CACnBG,QADmB;AAAA,MACTC,SADS,GACcJ,OADd,CACTI,SADS;AAAA,MACEC,OADF,GACcL,OADd,CACEK,OADF;AAAA,MAEbC,YAFa,GAE0BH,QAF1B,CAEnBI,IAFmB;AAAA,MAEQC,aAFR,GAE0BL,QAF1B,CAECM,KAFD;AAAA,MAGbC,aAHa,GAG4BN,SAH5B,CAGnBG,IAHmB;AAAA,MAGSI,cAHT,GAG4BP,SAH5B,CAGEK,KAHF;AAK3B,MAAIG,UAAU,GAAGX,KAAjB;;AAEA,SAAOW,UAAU,GAAGd,GAApB,EAAyB;AACvB,QAAMe,aAAa,GAAGd,SAAS,GAC3BJ,MAAM,CACHmB,EADH,CACMF,UADN,EACkBV,QADlB,EAEGa,GAFH,CAEO,CAFP,EAEUnB,IAAI,CAACoB,KAFf,EAGGC,OAHH,CAGWrB,IAAI,CAACoB,KAHhB,CAD2B,GAK3BrB,MAAM,CACHmB,EADH,CACMF,UADN,EACkBV,QADlB,EAEGa,GAFH,CAEOJ,cAAc,GAAG,CAFxB,EAE2BD,aAF3B,EAGGO,OAHH,CAGWrB,IAAI,CAACoB,KAHhB,CALJ;AAUA,QAAME,IAAI,GAAGL,aAAa,CAACK,IAAd,EAAb;AACA,QAAMC,KAAK,GAAGN,aAAa,CAACM,KAAd,EAAd;AACA,QAAMC,QAAQ,GAAGP,aAAa,CAACQ,UAAd,EAAjB;AACA,QAAMC,IAAI,GACRF,QAAQ,GAAGf,OAAX,GAAqBA,OAAO,GAAGe,QAAV,GAAqB,CAA1C,GAA8Cf,OAAO,GAAGe,QAAV,GAAqB,CADrE;AAGA,QAAMG,iBAAiB,GAAG5B,MAAM,CAC7BmB,EADuB,CACpBZ,QADoB,EAEvBgB,IAFuB,CAElBA,IAFkB,EAGvBC,KAHuB,CAGjBA,KAHiB,EAIvBG,IAJuB,CAIlBA,IAJkB,EAKvBP,GALuB,CAKnB,CALmB,EAKhBnB,IAAI,CAAC4B,GALW,EAMvBP,OANuB,CAMfrB,IAAI,CAAC4B,GANU,EAOvBC,QAPuB,CAOd,CAPc,EAOX7B,IAAI,CAAC8B,IAPM,EAQvBC,OARuB,EAA1B;AASA,QAAMC,mBAAmB,GAAGjC,MAAM,CAC/BmB,EADyB,CACtBS,iBADsB,EACHrB,QADG,EAEzBuB,QAFyB,CAEhBjB,aAFgB,EAEDF,YAFC,EAGzBqB,OAHyB,EAA5B;AAKA,QAAIJ,iBAAiB,IAAIK,mBAArB,IAA4CL,iBAAiB,GAAGzB,GAApE,EACE;;AAEF,QAAI8B,mBAAmB,IAAI3B,KAA3B,EAAkC;AAChC,aAAO,CAAC2B,mBAAD,EAAsBL,iBAAiB,GAAG,CAA1C,CAAP;AACD;;AAED,QAAMM,cAAc,GAAGhB,aAAa,CAACc,OAAd,EAAvB;AACAf,IAAAA,UAAU,GAAGiB,cAAb;AACD;AACF","sourcesContent":["import moment from 'moment-timezone'\n\nimport { GetNext, Interval, Unit } from '../scheduling.types'\n\n/**\n * Generates next occurrence interval for last weekday of month strategy\n */\nexport function getNextLastWeekdayOfMonth({\n  end,\n  isInitial,\n  options,\n  start,\n  timezone,\n}: GetNext): Interval | void {\n  const { duration, frequency, weekday } = options\n  const { unit: durationUnit, value: durationValue } = duration\n  const { unit: frequencyUnit, value: frequencyValue } = frequency\n\n  let dateCursor = start\n\n  while (dateCursor < end) {\n    const mStartOfMonth = isInitial\n      ? moment\n          .tz(dateCursor, timezone)\n          .add(1, Unit.Month)\n          .startOf(Unit.Month)\n      : moment\n          .tz(dateCursor, timezone)\n          .add(frequencyValue + 1, frequencyUnit)\n          .startOf(Unit.Month)\n\n    const year = mStartOfMonth.year()\n    const month = mStartOfMonth.month()\n    const startDay = mStartOfMonth.isoWeekday()\n    const date =\n      startDay > weekday ? weekday - startDay + 8 : weekday - startDay + 1\n\n    const nextOccurrenceEnd = moment\n      .tz(timezone)\n      .year(year)\n      .month(month)\n      .date(date)\n      .add(1, Unit.Day)\n      .startOf(Unit.Day)\n      .subtract(1, Unit.Week)\n      .valueOf()\n    const nextOccurrenceStart = moment\n      .tz(nextOccurrenceEnd, timezone)\n      .subtract(durationValue, durationUnit)\n      .valueOf()\n\n    if (nextOccurrenceEnd <= nextOccurrenceStart || nextOccurrenceEnd > end)\n      return\n\n    if (nextOccurrenceStart >= start) {\n      return [nextOccurrenceStart, nextOccurrenceEnd - 1]\n    }\n\n    const nextDateCursor = mStartOfMonth.valueOf()\n    dateCursor = nextDateCursor\n  }\n}\n"],"file":"getNextLastWeekdayOfMonth.js"}