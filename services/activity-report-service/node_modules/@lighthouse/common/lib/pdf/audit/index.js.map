{"version":3,"sources":["../../../src/pdf/audit/index.js"],"names":["Promise","isEmpty","buildAuditContent","buildTemplateContent","generateDefinition","getFormattedAddress","horizontalLine","text","twoColumnTable","getAuditEntryDetails","buildAuditPdf","pdfOptions","data","entity","timezone","timestamp","createdAt","title","fileTitle","generateContent","then","content","type","catch","err","Error","message","footerFields","gps","headerFields","score","entityDetails","gpsText","groupedData","locationText","referenceValue","timezoneHourTime","scoreText","reverseGeocoded","subTitle","headerTitle","style","headerScore","alignment","headerSubTitle","colSpan","address","headerAddress","scoreBreakdown","actual","max","scorePercentage","scoreTitle","body","titleTable","layout","widths","totalScoreTable","hLineTop","margin","hLineBottom","promises","entry","items","footerTemplate","formGroups","headerTemplate","props"],"mappings":"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","sourcesContent":["import Promise from 'bluebird'\nimport { isEmpty } from 'lodash'\n\nimport {\n  buildAuditContent,\n  buildTemplateContent,\n  generateDefinition,\n  getFormattedAddress,\n  horizontalLine,\n  text,\n  twoColumnTable,\n} from '../helpers'\n\nimport { getAuditEntryDetails } from '../../helpers'\n\n/**\n * buildAuditPdf\n *\n * @param {object} pdfOptions - the pdf options\n * @param {string} pdfOptions.fileTitle - pdf file title\n * @param {function} pdfOptions.footer - function executed to generate footer\n * @param {function} pdfOptions.header - function executed to generate header\n * @param {string} pdfOptions.logoUrl - pdf logo url\n * @param {array} pdfOptions.pageMargins - pdf page margins\n * @param {string} pdfOptions.pageOrientation - pdf page orientation\n * @param {string} pdfOptions.pageSize - pdf page size\n * @param {object} pdfOptions.styles - pdf styles\n * @param {object} pdfOptions.title - pdf title\n * @param {object} data - pdf data\n * @param {object} data.entity - audit document\n * @param {object} data.locations - locations documents\n * @param {object} data.settings - settings properties\n * @param {string} data.settings.awsS3BaseUrl - aws S3 base url\n * @param {string} data.settings.cloudinaryBaseUrl - cloudinary base url\n * @param {string} data.timezone - timezone string\n * @param {object} data.users - application user documents\n * @returns {Promise} returns pdfmake definition object\n */\nexport function buildAuditPdf(pdfOptions, data) {\n  const { entity, timezone } = data\n\n  const timestamp = entity.createdAt\n  const title = entity.title || 'Unknown'\n\n  const fileTitle = `Audit Report - ${title}`\n\n  return generateContent(data)\n    .then(content =>\n      generateDefinition({\n        content,\n        fileTitle,\n        timestamp,\n        timezone,\n        type: 'Audit',\n        ...pdfOptions,\n      })\n    )\n    .catch(err => {\n      throw new Error(`BuildAuditPdfError: ${err.message}`)\n    })\n}\n\nfunction generateContent(data) {\n  const { entity } = data\n\n  const {\n    footerFields = {},\n    gps = {},\n    headerFields = {},\n    score = {},\n    title = 'Unknown',\n  } = entity\n\n  const entityDetails = getAuditEntryDetails(data)\n\n  const {\n    gpsText,\n    groupedData,\n    locationText,\n    referenceValue,\n    timezoneHourTime,\n    scoreText,\n  } = entityDetails\n\n  const reverseGeocoded = gps.reverseGeocoded\n\n  const subTitle = `${locationText ||\n    gpsText} - ${timezoneHourTime} by ${referenceValue}`\n\n  const headerTitle = text(title, { style: 'title' })\n  const headerScore = text(scoreText, { alignment: 'right', style: 'title' })\n  const headerSubTitle = text(subTitle, { colSpan: 2, style: 'subTitle' })\n  const address = !isEmpty(reverseGeocoded)\n    ? getFormattedAddress(reverseGeocoded)\n    : ''\n  const headerAddress = text(address, { colSpan: 2, style: 'small' })\n\n  const scoreBreakdown = text(`${score.actual} / ${score.max}`, {\n    alignment: 'right',\n    style: 'totalScore',\n  })\n  const scorePercentage = text(scoreText, {\n    alignment: 'right',\n    colSpan: 2,\n    style: 'totalAuditScore',\n  })\n  const scoreTitle = text('Total Score', { style: 'totalScore' })\n\n  const body = !isEmpty(reverseGeocoded)\n    ? [[headerTitle, headerScore], [headerSubTitle], [headerAddress]]\n    : [[headerTitle, headerScore], [headerSubTitle]]\n\n  const titleTable = twoColumnTable({\n    body,\n    layout: 'noBorders',\n    style: 'titleTable',\n    widths: ['*', 80],\n  })\n\n  const totalScoreTable = twoColumnTable({\n    body: [[scoreTitle, scoreBreakdown], [scorePercentage]],\n    layout: 'noBorders',\n    widths: ['*', 80],\n  })\n\n  const hLineTop = horizontalLine({ margin: [0, 10, 0, 0] })\n  const hLineBottom = horizontalLine()\n\n  const promises = {\n    entry: buildAuditContent(groupedData.items),\n    footerTemplate: buildTemplateContent(footerFields.formGroups, data),\n    headerTemplate: buildTemplateContent(headerFields.formGroups, data),\n  }\n\n  return Promise.props(promises)\n    .then(({ entry, footerTemplate, headerTemplate }) => {\n      return [\n        titleTable,\n        ...headerTemplate,\n        ...entry,\n        hLineTop,\n        totalScoreTable,\n        hLineBottom,\n        ...footerTemplate,\n      ]\n    })\n    .catch(err => {\n      throw new Error(`GenerateContentError: ${err.message}`)\n    })\n}\n"],"file":"index.js"}